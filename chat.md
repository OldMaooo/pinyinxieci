# 看拼音写词 - 开发聊天记录总结

## 项目简介
一个帮助小学生通过手写练习掌握生词的网页应用，使用Canvas手写输入，百度AI识别，本地存储数据。

## 主要开发历程

### 版本迭代历史（v1.0.0 → v1.3.21）

#### 核心功能实现阶段（v1.0.0 - v1.2.0）
- 初始版本：基础手写输入、识别API集成
- 增强调试面板，添加详细错误日志
- 自动配置Vercel代理

#### 识别问题修复阶段（v1.2.1 - v1.3.2）
- **关键问题**：部署到GitHub Pages后识别失败，返回空结果
- **根本原因**：
  1. Vercel代理参数与本地不一致
  2. 图片预处理在深色模式下处理不当
  3. 二值化逻辑导致图片全黑或丢失文字
  4. Canvas尺寸计算错误（iPad上只显示1/4）
- **解决方案**：
  - 统一代理参数（仅access_token和image）
  - 深色模式使用RGB反转滤镜（白字+深色背景→白底黑字）
  - 改进图片预处理：二值化、文字区域检测、裁剪
  - 修正canvas尺寸计算（使用实际像素尺寸）

#### UI/UX优化阶段（v1.3.3 - v1.3.13）
- 田字格优化：缩小尺寸、去除外边框、增强虚线对比度
- 反馈区域移到田字格上方
- 正确答案字体回退：楷体→宋体→黑体
- 移除首页大标题，压缩间距
- 答题数量/计时器移除背景色
- 深色模式配色修正

#### 功能增强阶段（v1.3.14 - v1.3.18）
- 自动保存未完成练习（partial状态）
- 离开页面自动保存草稿
- 滚动/尺寸变化不清空笔迹
- 调试模式：数据入库并标记，默认视图过滤

#### 高级功能阶段（v1.3.19 - v1.3.21）
- 结果页沿用错题卡片样式
- 新增暂停/继续功能
- 新增纸质书写模式（不判题）
- 错题本只看错题开关
- 笔画撤销功能
- 上一题/下一题移至田字格左右
- 首页题目数量输入简化
- 结果页可手动修改对错状态
- 确认修改按钮
- 统计数据合并一行

## 关键技术点

### 1. 手写识别流程
```
Canvas绘制 → getSnapshot() → 图片预处理（二值化/裁剪） → 发送到百度API → 识别结果 → 判断对错
```

### 2. 图片预处理关键步骤
1. **缩放**：限制最大尺寸400px
2. **深色模式处理**：RGB反转（白字变黑字）
3. **二值化**：文字像素→纯黑，背景/网格→纯白
4. **文字区域检测**：扫描像素，排除网格线
5. **裁剪**：裁剪到文字区域+15px padding

### 3. 数据存储结构
```javascript
{
  wordBank: [],      // 题库
  practiceLogs: [],  // 练习记录（含details数组）
  errorWords: [],    // 错题本（含快照数组）
  settings: {}       // 设置（含practice配置）
}
```

### 4. 练习记录结构（v1.3.11后）
```javascript
{
  id: "log_xxx",
  date: "ISO日期",
  totalWords: 20,
  correctCount: 18,
  errorCount: 2,
  totalTime: 600,
  averageTime: 30,
  errorWords: ["word_id1", "word_id2"],
  details: [  // 每题详情
    { wordId: "xxx", correct: true, snapshot: "base64..." },
    { wordId: "yyy", correct: false, snapshot: "base64..." }
  ],
  status: "completed" | "partial",
  isDebug: false
}
```

## 重要修复记录

### 识别问题修复（v1.2.1 - v1.3.2）
- **问题**：百度API返回空结果（words_result: []）
- **原因分析**：
  1. 图片预处理过度，文字被移除
  2. 深色模式下白字被误判为背景
  3. 二值化逻辑错误导致全黑图片
  4. 网格线干扰识别
- **解决方案**：
  - 简化预处理逻辑
  - 深色模式RGB反转
  - 改进二值化和文字检测
  - 排除网格线干扰

### iPad兼容性问题（v1.3.2）
- **问题**：iPad上图片裁剪只显示1/4
- **原因**：canvas尺寸计算错误（除以devicePixelRatio两次）
- **解决**：使用canvas.width/height直接作为实际像素尺寸

### 自动保存问题（v1.3.18）
- **问题**：刷新页面后未完成练习丢失
- **解决**：每次答题后保存草稿，页面隐藏/关闭时入库为partial

## 用户反馈与改进

### UI/UX改进
1. **田字格优化**：尺寸调整、去除外边框、增强虚线对比度
2. **反馈位置**：移到田字格上方，减少高度
3. **统计显示**：合并到一行，正确率下方显示"正确X，错误Y"
4. **按钮布局**：上一题/下一题移至田字格左右，撤销按钮新增

### 功能增强
1. **笔画撤销**：记录路径历史，支持撤销最后一笔
2. **暂停功能**：练习过程中可暂停/继续
3. **纸质模式**：不判题模式，适合线下练习
4. **手动校验**：结果页可手动修改对错状态

### 数据完整性
1. **超时保存快照**：时间到自动保存当前书写内容
2. **优先显示本次快照**：结果页显示本次练习的快照，而非历史快照
3. **自动保存草稿**：防止刷新丢失数据

## 配置文件说明

### js/config.js
- 百度API配置（apiKey, apiSecret）
- 识别阈值配置

### js/version.js
- 版本号和更新日志

### api/baidu-proxy.js
- Vercel Serverless Function
- 代理百度API，解决CORS问题

## 部署说明

### GitHub Pages
- 静态文件托管
- 自动部署main分支

### Vercel
- Serverless Function代理
- 处理百度API调用

## 开发工具

### 调试模式
- 导航栏开关（桌面端显示）
- 显示调试面板
- 数据标记isDebug，非调试模式自动过滤

### 调试面板功能
- 环境信息显示
- 代理配置信息
- 实时日志（网络请求、识别结果等）
- 图片历史查看
- 一键复制所有日志

## 常见问题

### 识别返回空结果
- 检查图片预处理逻辑
- 确认深色模式处理正确
- 验证二值化和裁剪逻辑

### 数据丢失
- 已实现自动保存草稿
- 刷新/关闭前自动入库为partial

### iPad兼容性
- 已修复canvas尺寸计算
- 已优化触摸事件处理

## 下一步计划（Phase 2）
- 遗忘曲线复习系统
- 笔画顺序动画演示
- 学习模式（描红练习）
- 详细统计图表
- 多用户支持

---

*最后更新：2025-11-04*
*当前版本：v1.3.21*


