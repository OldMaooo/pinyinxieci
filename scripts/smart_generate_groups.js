const fs = require('fs');
const path = require('path');

// 常用词汇模板库（基于真实常用词）
const COMMON_PATTERNS = {
  // 常见前缀
  prefixes: ['大', '小', '老', '新', '好', '多', '少', '上', '下', '前', '后', '左', '右', '中', '里', '外', '高', '低', '长', '短', '快', '慢', '早', '晚', '红', '绿', '白', '黑', '黄', '蓝'],
  // 常见后缀
  suffixes: ['子', '儿', '头', '家', '人', '的', '了', '着', '过', '来', '去', '出', '入', '回', '到', '上', '下', '中', '里', '外'],
  // 常见动词
  verbs: ['看', '听', '说', '做', '走', '跑', '跳', '吃', '喝', '睡', '玩', '学', '写', '读', '画', '唱', '跳', '飞', '游', '爬'],
  // 常见名词
  nouns: ['天', '地', '人', '山', '水', '花', '草', '树', '鸟', '鱼', '狗', '猫', '马', '牛', '羊', '鸡', '鸭', '鹅', '车', '船'],
  // 常见形容词
  adjectives: ['好', '坏', '大', '小', '高', '低', '长', '短', '快', '慢', '新', '旧', '美', '丑', '热', '冷', '暖', '凉']
};

// 真实常用词组库（基于小学语文常用词）
const REAL_WORD_GROUPS = {
  '八': ['八个', '八月', '八十', '十八'],
  '巴': ['嘴巴', '尾巴', '下巴', '巴望'],
  '爸': ['爸爸', '老爸', '爸妈'],
  '白': ['白色', '白天', '白云', '明白'],
  '办': ['办法', '办事', '办理', '办公'],
  '半': ['一半', '半天', '半年', '半夜'],
  '本': ['本来', '本子', '书本', '根本'],
  '比': ['比较', '比赛', '比如', '相比'],
  '不': ['不是', '不要', '不能', '不会'],
  '才': ['才能', '刚才', '人才', '天才'],
  '厂': ['工厂', '厂房', '厂家'],
  '尺': ['尺子', '尺寸', '一尺'],
  '虫': ['虫子', '昆虫', '害虫'],
  '出': ['出来', '出去', '出现', '出发'],
  '大': ['大小', '大家', '大人', '大地'],
  '刀': ['刀子', '小刀', '大刀'],
  '东': ['东西', '东方', '东北', '东南'],
  '多': ['多少', '很多', '多数', '多余'],
  '儿': ['儿子', '女儿', '儿童', '这儿'],
  '耳': ['耳朵', '耳机', '耳环'],
  '二': ['二个', '二月', '二十', '十二'],
  '风': ['大风', '风雨', '风景', '风筝'],
  '个': ['一个', '个人', '个子', '几个'],
  '工': ['工作', '工人', '工厂', '工具'],
  '公': ['公共', '公园', '公平', '公开'],
  '关': ['关心', '关门', '关系', '关键'],
  '禾': ['禾苗', '禾田'],
  '和': ['和平', '和气', '和好', '和声'],
  '火': ['大火', '火苗', '火焰', '火灾'],
  '几': ['几个', '几天', '几时', '几何'],
  '见': ['看见', '见面', '见到', '见识'],
  '九': ['九个', '九月', '九十', '十九'],
  '开': ['开门', '开始', '开心', '开放'],
  '可': ['可以', '可能', '可是', '可爱'],
  '口': ['门口', '开口', '口水', '口音'],
  '来': ['来到', '来回', '来去', '来年'],
  '了': ['好了', '完了', '走了', '来了'],
  '里': ['里面', '这里', '那里', '心里'],
  '力': ['力气', '力量', '用力', '努力'],
  '立': ['立正', '站立', '立刻', '立即'],
  '六': ['六个', '六月', '六十', '十六'],
  '妈': ['妈妈', '老妈', '爸妈'],
  '马': ['马上', '马车', '马路', '马儿'],
  '门': ['门口', '开门', '关门', '大门'],
  '木': ['木头', '树木', '木门', '木桌'],
  '目': ['目的', '目标', '目光', '目录'],
  '男': ['男孩', '男人', '男女', '男生'],
  '你': ['你们', '你的', '你好', '你来'],
  '鸟': ['小鸟', '鸟儿', '鸟类', '鸟巢'],
  '牛': ['牛儿', '牛奶', '牛肉', '黄牛'],
  '女': ['女孩', '女人', '女儿', '女生'],
  '七': ['七个', '七月', '七十', '十七'],
  '去': ['回去', '来去', '去年', '去去'],
  '人': ['人们', '人民', '大人', '小人'],
  '日': ['日子', '日出', '日落', '日记'],
  '三': ['三个', '三月', '三十', '十三'],
  '山': ['大山', '山上', '山下', '山水'],
  '上': ['上面', '上来', '上去', '上学'],
  '少': ['多少', '很少', '少年', '少女'],
  '十': ['十个', '十月', '十分', '十岁'],
  '石': ['石头', '石子', '石块', '石桥'],
  '是': ['是的', '不是', '就是', '还是'],
  '手': ['小手', '手里', '手中', '手指'],
  '水': ['大水', '水花', '水草', '水果'],
  '四': ['四个', '四月', '四十', '十四'],
  '天': ['天空', '天上', '天气', '白天'],
  '田': ['田地', '田野', '田里', '农田'],
  '头': ['头上', '头发', '头顶', '头儿'],
  '土': ['土地', '土里', '泥土', '黄土'],
  '王': ['大王', '王子', '王后', '国王'],
  '卫': ['卫生', '保卫', '守卫'],
  '我': ['我们', '我的', '我来', '我去'],
  '五': ['五个', '五月', '五十', '十五'],
  '午': ['中午', '上午', '下午', '午时'],
  '西': ['西方', '西边', '东西', '西北'],
  '下': ['下面', '下来', '下去', '下雨'],
  '先': ['先生', '先来', '先去', '先走'],
  '小': ['大小', '小的', '小人', '小鸟'],
  '心': ['心里', '心中', '心情', '心意'],
  '牙': ['牙齿', '牙儿', '刷牙'],
  '羊': ['羊儿', '小羊', '山羊', '绵羊'],
  '也': ['也是', '也好', '也要', '也行'],
  '叶': ['叶子', '树叶', '叶片', '叶儿'],
  '一': ['一个', '一起', '一样', '一天'],
  '用': ['用来', '有用', '不用', '用力'],
  '有': ['有的', '没有', '有用', '有时'],
  '又': ['又来', '又去', '又是', '又要'],
  '右': ['右边', '右手', '右面', '左右'],
  '雨': ['下雨', '雨水', '雨点', '雨伞'],
  '月': ['月亮', '月份', '月儿', '月牙'],
  '云': ['白云', '云朵', '云彩', '乌云'],
  '在': ['在家', '在学校', '在这里', '在在'],
  '长': ['长短', '长大', '长高', '长度'],
  '爪': ['爪子', '鸡爪', '猫爪'],
  '正': ['正好', '正在', '正确', '正午'],
  '只': ['只有', '只是', '一只', '几只'],
  '中': ['中间', '中心', '中国', '中午'],
  '竹': ['竹子', '竹叶', '竹竿', '竹林'],
  '子': ['儿子', '女子', '孩子', '桌子'],
  '左': ['左边', '左手', '左面', '左右'],
  '厨': ['厨房', '厨师', '厨具'],
  '摧': ['摧毁', '摧残', '摧折'],
  '废': ['废物', '废弃', '废品', '作废'],
  '沸': ['沸腾', '沸水', '沸点'],
  '伏': ['埋伏', '伏击', '伏案'],
  '腐': ['腐烂', '腐败', '腐蚀'],
  '归': ['归来', '回归', '归还', '归家'],
  '裹': ['包裹', '裹住', '裹紧']
};

function loadJson(filePath) {
  const absPath = path.resolve(filePath);
  if (!fs.existsSync(absPath)) return null;
  return JSON.parse(fs.readFileSync(absPath, 'utf-8'));
}

function generateSmartGroups(word, allWordEntries) {
  // 1. 优先使用真实词组库
  if (REAL_WORD_GROUPS[word]) {
    return REAL_WORD_GROUPS[word];
  }

  // 2. 从题库中查找包含该字的真实词语
  const groups = [];
  const seen = new Set();
  
  allWordEntries.forEach(({ word: other }) => {
    if (other.length >= 2 && other.includes(word) && !seen.has(other)) {
      groups.push(other);
      seen.add(other);
    }
  });

  // 3. 如果找到真实词语，返回
  if (groups.length >= 2) {
    return groups.slice(0, 4);
  }

  // 4. 如果都找不到，返回空数组（不使用不合理的智能组合）
  // 前端会使用拼音显示，这是合理的fallback
  return [];
}

function main() {
  const wordGroupsPath = 'data/word-groups-all.json';
  const wordGroups = loadJson(wordGroupsPath) || {};
  
  // 找出缺少词组的字
  const allWordbankFiles = [
    '一年级上册.json', '一年级下册.json',
    '二年级上册.json', '二年级下册.json',
    '三年级上册.json', '三年级下册.json',
    '四年级上册.json', '四年级下册.json',
    '五年级上册.json', '五年级下册.json',
    '六年级上册.json', '六年级下册.json'
  ];

  const allWordEntries = [];
  allWordbankFiles.forEach(file => {
    const data = loadJson(path.join('data/wordbank', file));
    if (data && Array.isArray(data.wordBank)) {
      data.wordBank.forEach(entry => {
        const word = (entry.word || '').trim();
        if (word && word.length >= 1) {
          allWordEntries.push({ word, entry });
        }
      });
    }
  });

  const wordsNeedingGroups = [];
  Object.keys(wordGroups).forEach(word => {
    if (!wordGroups[word] || wordGroups[word].length === 0) {
      wordsNeedingGroups.push(word);
    }
  });

  // 只处理前50个
  const wordsToProcess = wordsNeedingGroups.slice(0, 50);
  console.log(`[smart_generate_groups] 找到 ${wordsNeedingGroups.length} 个缺少词组的字，先处理前50个:`);
  console.log(wordsToProcess.join('、'));

  let generated = 0;
  wordsToProcess.forEach(word => {
    const groups = generateSmartGroups(word, allWordEntries);
    if (groups.length > 0) {
      wordGroups[word] = groups;
      generated++;
      console.log(`[smart_generate_groups] ✅ "${word}": [${groups.join(', ')}]`);
    } else {
      console.log(`[smart_generate_groups] ⚠️ "${word}": 无法生成词组`);
    }
  });

  fs.writeFileSync(wordGroupsPath, JSON.stringify(wordGroups, null, 2));
  console.log(`\n[smart_generate_groups] ✅ 完成！为 ${generated}/50 个字生成了词组`);
}

main();
